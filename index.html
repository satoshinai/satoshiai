<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="public, max-age=3600">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Satoshi's Enigma</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-height: 100vh;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 384px;
      width: 100%;
      text-align: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 16px;
      color: #f0c040; /* Satoshi金色 */
    }
    input {
      width: 100%;
      padding: 8px;
      background: #1a1a1a;
      border: 1px solid #4a4a4a;
      color: #fff;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    button {
      width: 100%;
      padding: 8px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #4a4a4a;
    }
    .response, .code-message {
      margin-top: 16px;
      white-space: pre-wrap;
    }
    .chatroom {
      height: 256px;
      overflow-y: auto;
      background: #1a1a1a;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 16px;
    }
    .chat-message {
      margin-bottom: 8px;
    }
    .payment-link {
      display: block;
      margin-top: 16px;
      padding: 8px;
      background: #16a34a;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
    }
    .payment-link:hover {
      background: #22c55e;
    }
    footer {
      color: #6b7280;
      font-size: 12px;
      text-align: center;
      max-width: 384px;
      margin-top: 32px;
    }
    .hint {
      font-size: 12px;
      color: #aaa;
      margin-top: 8px;
    }
    .error {
      color: #ef4444;
      margin-top: 16px;
    }
    .privacy {
      font-size: 12px;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    let input = '';
    let response = '';
    let showPayment = false;
    let codeInput = '';
    let chatMessages = [];
    let chatInput = '';
    let isChatroom = false;
    let codeMessage = '';
    const userId = Math.random().toString(36).substring(2);
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby4PDFuQ6iYlJd3CwW9_dgux7EB969fCxnOFaFk2oyva8syXYd4mHqoUlrASySXUYiQ/exec';

    function fetchMessages() {
      if (isChatroom) {
        fetch(`${GAS_URL}?action=getMessages`)
          .then(res => res.json())
          .then(data => {
            chatMessages = data.messages || [];
            render();
          })
          .catch(error => console.error('Error fetching messages:', error));
        setTimeout(fetchMessages, 5000);
      }
    }

    async function handleSubmit() {
      if (!input) return;
      try {
        const isCode = /^[a-zA-Z0-9]{16}$/.test(input);
        if (isCode) {
          const res = await fetch(`${GAS_URL}?action=verifyCode&code=${input}`);
          const result = await res.json();
          if (result.status === 'valid') {
            isChatroom = true;
            fetchMessages();
            codeMessage = result.message;
          } else {
            codeMessage = result.message;
          }
        } else {
          const res = await fetch(`${GAS_URL}?action=checkQuestion&userId=${userId}&question=${encodeURIComponent(input)}`);
          const result = await res.json();
          response = result.response || 'Error: No response from server.';
          showPayment = result.showPayment || false;
          codeMessage = '';
        }
        input = '';
        render();
      } catch (error) {
        response = 'Error processing request.';
        codeMessage = '';
        console.error('Submission error:', error);
        render();
      }
    }

    async function handleChatSubmit() {
      if (!chatInput.match(/^[A-Z]{2}\d{2}$/)) return;
      try {
        await fetch(`${GAS_URL}?action=addMessage&text=${chatInput}`);
        chatInput = '';
        fetchMessages();
      } catch (error) {
        console.error('Chat error:', error);
      }
    }

    function render() {
      root.innerHTML = `
        <div class="container">
          ${isChatroom ? `
            <h1>Chatroom</h1>
            <div class="chatroom">
              ${chatMessages.map(msg => `<div class="chat-message">${msg}</div>`).join('')}
            </div>
            <input id="chatInput" type="text" value="${chatInput}" placeholder="Enter AB12 format...">
            <button onclick="handleChatSubmit()">Send</button>
          ` : `
            <h1>Satoshi's Enigma</h1>
            <input id="input" type="text" value="${input}" placeholder="Ask a question...">
            <button onclick="handleSubmit()">Submit</button>
            ${response ? `<div class="response">${response}</div>` : ''}
            ${showPayment ? `<a href="https://nowpayments.io/payment/?iid=6068590454" class="payment-link">Support the Legacy ($29.00)</a>` : ''}
            ${codeMessage ? `<pre class="code-message">${codeMessage}</pre>` : ''}
            <div class="hint">Uncover hidden truths—ask about my legacy! Future revelations await...</div>
            <div class="privacy"><a href="/privacy-policy">Privacy Policy</a> | Consent required.</div>
            ${showPayment ? `
              <footer>
                <p>Disclaimer: Satoshi's Enigma is an experimental game, not a financial product. Codes are unique digital fragments (max 350,000), with no guaranteed value. Participation costs $29.00 (non-refunded). Future use, including potential digital heritage, is speculative. Use at your own risk.</p>
              </footer>
            ` : ''}
          `}
        </div>
      `;
      if (!isChatroom) {
        document.getElementById('input').addEventListener('input', (e) => { input = e.target.value; });
      } else {
        document.getElementById('chatInput').addEventListener('input', (e) => { chatInput = e.target.value; });
      }
    }

    render();
  </script>
</body>
</html>
