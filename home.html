<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nakamoto Enigma - Challenge</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #0d0d0d;
      color: #ffcc00;
      font-family: 'Orbitron', monospace;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      text-align: center;
      max-width: 600px;
      width: 100%;
    }
    h1 {
      font-size: 2em;
      text-shadow: 0 0 10px #ffcc00;
    }
    p, input, button {
      font-family: 'Orbitron', monospace;
    }
    input {
      padding: 10px;
      margin: 10px;
      background: #1a1a1a;
      border: 2px solid #ffcc00;
      color: #ffcc00;
      font-size: 1em;
    }
    button {
      padding: 12px 24px;
      margin: 10px;
      background: transparent;
      border: 2px solid #ffcc00;
      color: #ffcc00;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px #ffcc00;
    }
    button:hover {
      background: #ffcc00;
      color: #0d0d0d;
      box-shadow: 0 0 20px #ffcc00;
    }
    #success, #finalSuccess {
      display: none;
    }
    #messages {
      margin-top: 20px;
      text-align: left;
    }
    .share-selector {
      display: none;
      position: absolute;
      background: #1a1a1a;
      border: 2px solid #ffcc00;
      padding: 10px;
      margin-top: 5px;
    }
    .share-selector button {
      display: block;
      width: 100%;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Nakamoto Enigma</h1>
    <div id="challenge">
      <p>Challenge Level: <span id="level"></span></p>
      <p>Cipher Type: <span id="cipherType"></span></p>
      <p>Encrypted Code: <span id="encrypted"></span></p>
      <p>Key Hint: <span id="keyHint"></span></p>
      <p>Attempts Left: <span id="attempts"></span></p>
      <p id="response"></p>
      <input type="text" id="nameInput" placeholder="Your Name">
      <input type="text" id="challengeInput" placeholder="Decoded Message">
      <button onclick="checkChallenge()">Decrypt</button>
    </div>
    <div id="success">
      <p id="challengeMessage"></p>
      <button onclick="toggleShareSelector()">Share Victory</button>
      <div id="shareSelector" class="share-selector">
        <button onclick="shareSuccess('x')">Share to X</button>
        <button onclick="shareSuccess('facebook')">Share to Facebook</button>
      </div>
      <button onclick="generateImage()">Generate Shareable Image</button>
      <button onclick="nextChallenge()">Next Challenge</button>
    </div>
    <div id="finalSuccess">
      <p>You have mastered all Nakamoto Ciphers!</p>
      <button onclick="toggleShareSelector()">Share Victory</button>
      <div id="shareSelector" class="share-selector">
        <button onclick="shareSuccess('x')">Share to X</button>
        <button onclick="shareSuccess('facebook')">Share to Facebook</button>
      </div>
      <button onclick="generateImage()">Generate Shareable Image</button>
      <button onclick="window.location.href='https://www.paypal.com/donate?hosted_button_id=YOUR_BUTTON_ID'">Donate</button>
      <input type="text" id="messageInput" placeholder="Your Victory Message">
      <button onclick="postMessage()">Post Message</button>
      <div id="messages"></div>
    </div>
  </div>
  <script>
    let currentLevel = 1;
    let userId = localStorage.getItem('userId') || generateUUID();
    localStorage.setItem('userId', userId);
    let attempts = 3;

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function toggleShareSelector() {
      const selector = document.getElementById('shareSelector');
      selector.style.display = selector.style.display === 'block' ? 'none' : 'block';
    }

    async function checkChallenge() {
      const name = document.getElementById('nameInput').value || 'Anonymous';
      const input = document.getElementById('challengeInput').value;
      const params = new URLSearchParams({
        action: 'checkChallenge',
        userId,
        name,
        input,
        encrypted: document.getElementById('encrypted').textContent,
        keyHint: document.getElementById('keyHint').textContent,
        attempts,
        level: currentLevel
      });
      const response = await fetch(`?${params}`);
      const data = await response.json();
      document.getElementById('response').textContent = data.response || data.challengeMessage;
      document.getElementById('attempts').textContent = data.attemptsLeft;
      if (data.progress > 0 && data.progress < 3) {
        document.getElementById('challenge').style.display = 'none';
        document.getElementById('success').style.display = 'block';
        document.getElementById('challengeMessage').textContent = data.challengeMessage;
        currentLevel = data.progress;
      } else if (data.progress === 3) {
        document.getElementById('challenge').style.display = 'none';
        document.getElementById('success').style.display = 'none';
        document.getElementById('finalSuccess').style.display = 'block';
        getMessages();
      }
      if (data.attemptsLeft < attempts) {
        attempts = data.attemptsLeft;
        if (attempts === 0) {
          document.getElementById('encrypted').textContent = data.encrypted;
          document.getElementById('keyHint').textContent = data.keyHint;
          attempts = 3;
          document.getElementById('attempts').textContent = attempts;
        }
      }
    }

    async function shareSuccess(platform) {
      const shareText = `I have unraveled the Nakamoto Cipher at Level ${currentLevel}! UserID: ${userId} - Join the enigma at https://satoshinai.github.io/satoshiai/`;
      const canvas = document.createElement('canvas');
      canvas.width = 400;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#0d0d0d';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#ffcc00';
      ctx.lineWidth = 2;
      for (let i = 0; i < canvas.width; i += 20) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      for (let i = 0; i < canvas.height; i += 20) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(canvas.width, i);
        ctx.stroke();
      }
      ctx.fillStyle = '#ffcc00';
      ctx.font = '20px Orbitron';
      ctx.textAlign = 'center';
      ctx.fillText('Nakamoto Enigma Victory!', canvas.width / 2, 50);
      ctx.fillText(`Level ${currentLevel} Conquered`, canvas.width / 2, 80);
      ctx.fillText(`User: ${document.getElementById('nameInput').value || 'Anonymous'}`, canvas.width / 2, 110);
      ctx.fillText(`ID: ${userId.slice(0, 8)}`, canvas.width / 2, 140);
      ctx.fillText(`Time: ${new Date().toLocaleString()}`, canvas.width / 2, 170);
      const imageData = canvas.toDataURL('image/png');
      if (navigator.share && platform !== 'instagram') {
        const file = await fetch(imageData).then(res => res.blob()).then(blob => new File([blob], `nakamoto_enigma_level${currentLevel}.png`, { type: 'image/png' }));
        await navigator.share({
          text: shareText,
          files: [file]
        });
      } else {
        const link = document.createElement('a');
        link.href = imageData;
        link.download = `nakamoto_enigma_level${currentLevel}.png`;
        link.click();
        const url = platform === 'x' ? `https://x.com/intent/tweet?text=${encodeURIComponent(shareText)}` :
                    platform === 'facebook' ? `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://satoshinai.github.io/satoshiai/')}&quote=${encodeURIComponent(shareText)}` :
                    'https://www.instagram.com/';
        window.open(url, '_blank');
      }
      toggleShareSelector();
    }

    function generateImage() {
      const shareText = `I have unraveled the Nakamoto Cipher at Level ${currentLevel}! UserID: ${userId} - Join the enigma at https://satoshinai.github.io/satoshiai/`;
      const canvas = document.createElement('canvas');
      canvas.width = 400;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#0d0d0d';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#ffcc00';
      ctx.lineWidth = 2;
      for (let i = 0; i < canvas.width; i += 20) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      for (let i = 0; i < canvas.height; i += 20) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(canvas.width, i);
        ctx.stroke();
      }
      ctx.fillStyle = '#ffcc00';
      ctx.font = '20px Orbitron';
      ctx.textAlign = 'center';
      ctx.fillText('Nakamoto Enigma Victory!', canvas.width / 2, 50);
      ctx.fillText(`Level ${currentLevel} Conquered`, canvas.width / 2, 80);
      ctx.fillText(`User: ${document.getElementById('nameInput').value || 'Anonymous'}`, canvas.width / 2, 110);
      ctx.fillText(`ID: ${userId.slice(0, 8)}`, canvas.width / 2, 140);
      ctx.fillText(`Time: ${new Date().toLocaleString()}`, canvas.width / 2, 170);
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = `nakamoto_enigma_level${currentLevel}.png`;
      link.click();
    }

    async function nextChallenge() {
      document.getElementById('success').style.display = 'none';
      document.getElementById('challenge').style.display = 'block';
      const params = new URLSearchParams({
        action: 'checkChallenge',
        userId,
        name: document.getElementById('nameInput').value || 'Anonymous',
        level: currentLevel + 1
      });
      const response = await fetch(`?${params}`);
      const data = await response.json();
      currentLevel = data.level;
      document.getElementById('level').textContent = data.level;
      document.getElementById('cipherType').textContent = data.cipherType;
      document.getElementById('encrypted').textContent = data.encrypted;
      document.getElementById('keyHint').textContent = data.keyHint;
      document.getElementById('attempts').textContent = data.attemptsLeft;
      document.getElementById('response').textContent = '';
      document.getElementById('challengeInput').value = '';
    }

    async function postMessage() {
      const message = document.getElementById('messageInput').value;
      if (message) {
        const params = new URLSearchParams({
          action: 'submitMessage',
          userId,
          name: document.getElementById('nameInput').value || 'Anonymous',
          message
        });
        await fetch(`?${params}`);
        document.getElementById('messageInput').value = '';
        getMessages();
      }
    }

    async function getMessages() {
      const response = await fetch('?action=getMessages');
      const data = await response.json();
      const messages = data.messages || [];
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = messages.map(msg => `<p>${msg[0]} (${msg[1]}): ${msg[2]} - ${msg[3]}</p>`).join('');
    }

    window.onload = async () => {
      const params = new URLSearchParams({
        action: 'checkChallenge',
        userId,
        level: 1
      });
      const response = await fetch(`?${params}`);
      const data = await response.json();
      document.getElementById('level').textContent = data.level;
      document.getElementById('cipherType').textContent = data.cipherType;
      document.getElementById('encrypted').textContent = data.encrypted;
      document.getElementById('keyHint').textContent = data.keyHint;
      document.getElementById('attempts').textContent = data.attemptsLeft;
    };
  </script>
</body>
</html>
